# NuGetSpike1
**NuGet packages**: working with symbols and source code; debugging ("stepping into") a package source code.

## Create NuGet package ##

There are some prerequisits to create a debuggable NuGet package.

### The .csprog file ###
The orignal (fresh, brand new, generated by VS2019 project file looks like this:
```
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>netcoreapp3.1</TargetFramework>
  </PropertyGroup>

</Project>
```

In order to make the NuGet package debuggable the following lines have to be added to the .csproj (easy to figure out what, no means to **bold** lines in source):
```
<Project Sdk="Microsoft.NET.Sdk">

    <PropertyGroup>
        <TargetFramework>netcoreapp3.1</TargetFramework>
        <Version>2.0.0</Version>    <!-- This will be the NuGet package version -->
    </PropertyGroup>

    <PropertyGroup>
        <TargetFramework>netcoreapp2.1</TargetFramework>

        <!-- Optional: Publish the repository URL in the built .nupkg (in the NuSpec <Repository> element) -->
        <PublishRepositoryUrl>true</PublishRepositoryUrl>

        <!-- Optional: Embed source files that are not tracked by the source control manager in the PDB -->
        <EmbedUntrackedSources>true</EmbedUntrackedSources>

        <!-- Optional: Build symbol package (.snupkg) to distribute the PDB containing Source Link -->
        <IncludeSymbols>true</IncludeSymbols>
        <SymbolPackageFormat>snupkg</SymbolPackageFormat>

        <RepositoryType>git</RepositoryType>

        <!-- This is where the repository is located, as in many other cases - github -->
        <RepositoryUrl>https://github.com/achristov/NuGetSpike1/</RepositoryUrl>
        
        <!-- The Company... -->
        <Company>SumoSoft</Company>
        
        <!-- ... and the Author(s) -->
        <Authors>achristov</Authors>

        <!-- Same as repository URL (in this particular case) -->
        <PackageProjectUrl>https://github.com/achristov/NuGetSpike1/</PackageProjectUrl>
    </PropertyGroup>

    <ItemGroup>
      <PackageReference Include="Microsoft.SourceLink.GitHub" Version="1.0.0">
        <PrivateAssets>all</PrivateAssets>
        <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
      </PackageReference>
    </ItemGroup>
</Project>
```

As you can see the project to be packed references ``` Microsoft.SourceLink.GitHub ``` package. This, plus the SourceLink enabled in Options -> Debug -> General, makes the debugger load the source code from the specified location.

Before that however, few otehr things should be set. VS2019 NuGet package editor does not allow for supplying branch and commit id to the package metadata (.nuspec). So, either edit this data manually 
```
    <repository type="git" url="https://github.com/achristov/NuGetSpike1/" commit="6ecca09741421c0c2a13fa426ffad61feaca0077" />
```
(**UNANSWERED QUESTIONS SO FAR**: branch omitted, perhaps because it is master (?); if commit id is also missing perhaps the last one would be picked (??)).

Now packing the file with the command bellow produces two packages insterad, a regular one (.nupkg) and a symbol, conaining the .pdb one (.snupkg).

Console:
```
    dotnet pack MyPackage.csproj -p:IncludeSymbols=true -p:SymbolPackageFormat=snupkg
```    
Output:
```
Microsoft (R) Build Engine version 16.7.0-preview-20310-07+ee1c9fd0c for .NET
Copyright (C) Microsoft Corporation. All rights reserved.

  Determining projects to restore...
  All projects are up-to-date for restore.
  You are using a preview version of .NET Core. See: https://aka.ms/dotnet-core-preview
  MyPackage -> D:\Projects\2019\NuGetSpike1\MyPackage\bin\Debug\netcoreapp3.1\MyPackage.dll
  Successfully created package 'D:\Projects\2019\NuGetSpike1\MyPackage\bin\Debug\MyPackage.2.0.0.nupkg'.
  Successfully created package 'D:\Projects\2019\NuGetSpike1\MyPackage\bin\Debug\MyPackage.2.0.0.snupkg'.
```  

![Create packages](https://github.com/achristov/NuGetSpike1/blob/Documentation/Images/Annotation%202020-07-09%20140213.png "Directory structure after 'dotnet pack...'")

It is helpful to load the package in NuGet Explorer and see if SourceLink is enabled:


## Push the package ##

Console:
```
dotnet nuget push -s http://baget.local/v3/index.json bin\Debug\MyPackage.2.0.0.nupkg -k 123456
```

Output:
```
Pushing MyPackage.2.0.0.nupkg to 'http://baget.local/api/v2/package'...
  PUT http://baget.local/api/v2/package/
  Created http://baget.local/api/v2/package/ 699ms                      
Your package was pushed.
Pushing MyPackage.2.0.0.snupkg to 'http://baget.local/api/v2/symbol'...  
  PUT http://baget.local/api/v2/symbol/
  Created http://baget.local/api/v2/symbol/ 24ms
Your package was pushed.
```

The Assembly (.dll)
It is in .nupkg (as usual)

![Create packages-1](https://github.com/achristov/NuGetSpike1/blob/Documentation/Images/Annotation%202020-07-09%20141015.png "Contents of .nupkg in NuGet Explorer")

The Symbols (.pdb)
The program database is stored in MyPackage.snupkg

![Create packages-2](https://github.com/achristov/NuGetSpike1/blob/Documentation/Images/Annotation%202020-07-09%20141133.png "Contents of .snupkg in NuGet Explorer")

At this point stepping into package's source code is possible. The debugger expects the package's program database (.pdb) file in the following location:

![Debug-1](https://github.com/achristov/NuGetSpike1/blob/Documentation/Images/Annotation%202020-07-09%20142220.png "'.pdb' location")

When the .pdb is missing however, say, when the package is built elsewhere, the debugger downloads the symbols from the symbol server (in my case [BaGet](https://github.com/loic-sharma/BaGet "BaGet on GitHub") server). 

If the code is missing too it is downloaded from a location specfied in the package metadata. I use NuGet explorer and set the following metadata fields like this:

![Metadata](https://github.com/achristov/NuGetSpike1/blob/Documentation/Images/Annotation%202020-07-09%20155254.png  "Metadata source code fields contents")

The NuGet server I use is [BaGet](https://github.com/loic-sharma/BaGet "BaGet on GitHub") and the info about the package it displays looks like this:

![BaGet](https://github.com/achristov/NuGetSpike1/blob/Documentation/Images/Annotation%202020-07-09%20155933.png  "BaGet server displaying info about the package")



